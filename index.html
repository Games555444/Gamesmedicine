<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M√©dico en Misi√≥n ‚Äî Emergencia Total (v3)</title>
  <meta name="description" content="M√©dico en Misi√≥n v3: modo Verdadero/Falso, fondo animado, minijuegos, eventos sorpresa y m√°s preguntas. Listo para GitHub Pages." />
  <style>
    :root{
      --bg:#041021; --panel:#071522; --accent:#06b6d4; --accent2:#7c3aed; --muted:#9fb1c6; --good:#10b981; --bad:#ef4444; --glass:rgba(255,255,255,0.03);
      --max-width:1200px; --ui-radius:12px; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; color:#eaf3fb;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#021226,#02101a);}
    .app{max-width:var(--max-width);margin:12px auto;padding:14px}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:60px;height:60px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px}
    h1{margin:0;font-size:18px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    /* layout */
    .game-wrap{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:12px}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:var(--ui-radius);box-shadow:0 12px 30px rgba(2,6,23,0.6);backdrop-filter: blur(6px)}

    /* stage */
    .stage{position:relative;min-height:720px;border-radius:var(--ui-radius);overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    /* animated background layers */
    .bg-layer{position:absolute;inset:0;background-size:cover;background-position:center;transition:filter .6s ease,opacity .8s ease}
    .bg-layer.overlay{background:linear-gradient(180deg,rgba(10,20,30,0.4),rgba(2,6,12,0.5));mix-blend-mode:multiply;pointer-events:none}

    /* subtle animated lights */
    .light{position:absolute;width:120px;height:120px;border-radius:50%;filter:blur(40px);opacity:0.12;animation:float 8s linear infinite}
    .light.l1{left:8%;top:12%;background:radial-gradient(circle,#4fd1c5,#0ea5a3)}
    .light.l2{right:6%;top:20%;background:radial-gradient(circle,#7c3aed,#5b21b6);animation-duration:10s}
    .light.l3{left:40%;bottom:6%;background:radial-gradient(circle,#60a5fa,#2563eb);animation-duration:12s}
    @keyframes float{0%{transform:translateY(0) translateX(0)}50%{transform:translateY(-18px) translateX(8px)}100%{transform:translateY(0) translateX(0)}}

    /* particles (very subtle) */
    .particles{position:absolute;inset:0;pointer-events:none}
    .particle{position:absolute;width:4px;height:4px;border-radius:50%;opacity:.08}

    .stage-header{position:relative;display:flex;justify-content:space-between;align-items:center;padding:12px 14px;z-index:9}
    .hud{display:flex;gap:12px;align-items:center}
    .score{font-weight:800}
    .small{font-size:13px;color:var(--muted)}

    .patient-area{display:flex;gap:14px;padding:12px;position:relative;z-index:9}
    .patient-card{width:360px;background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03)}

    .avatar-wrap{width:100%;height:260px;border-radius:8px;overflow:hidden;position:relative;background:#02121a;display:flex;align-items:center;justify-content:center}
    .avatar-img{width:100%;height:100%;object-fit:cover;display:block;transform-origin:center center;transition:transform .5s ease,filter .4s ease}
    .avatar-gloss{position:absolute;inset:0;pointer-events:none;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}

    .vitals{margin-top:10px}
    .bar{height:18px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--good),#60a5fa);width:100%;transition:width .5s ease}
    .stat-row{display:flex;justify-content:space-between;margin-top:8px;color:var(--muted);font-size:13px}

    .stage-canvas{flex:1;position:relative;border-radius:8px;margin:12px;padding:18px;overflow:hidden;display:flex;flex-direction:column;z-index:6}
    .spawn-item{position:absolute;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.06);backdrop-filter:blur(4px);cursor:pointer;border:1px solid rgba(255,255,255,0.03);font-weight:700;user-select:none;transition:transform .12s ease}
    .spawn-item:active{transform:scale(.96)}
    .spawn-item.syringe{background:linear-gradient(90deg,#ecfccb,#bbf7d0);color:#07211a}
    .spawn-item.clock{background:linear-gradient(90deg,#e0f2fe,#bae6fd);color:#052032}
    .spawn-item.hint{background:linear-gradient(90deg,#fee2e2,#fecaca);color:#2b0a0a}

    /* question modal */
    .qmodal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:linear-gradient(180deg,#071022,#07182a);padding:18px;border-radius:12px;width:720px;max-width:96%;box-shadow:0 30px 80px rgba(2,6,23,0.8);z-index:10002}
    .qmodal .qheader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .qmodal .qtext{font-size:18px;margin-bottom:12px}
    .opts{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .optbtn{padding:12px;border-radius:10px;background:var(--glass);cursor:pointer;border:1px solid rgba(255,255,255,0.03);font-weight:700}
    .optbtn.disabled{opacity:.45;pointer-events:none}

    /* right panel */
    aside.controls{position:sticky;top:18px;height:fit-content}
    .controls h3{margin:6px 0 8px}
    .btn{display:inline-block;padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:white;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .level-list{display:flex;flex-direction:column;gap:8px}

    /* achievements */
    .achievements{margin-top:12px}
    .medal{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03)}
    .medal.locked{opacity:.45}

    /* toast & small UI */
    .toast{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,#0b1220,#07202f);padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 30px rgba(0,0,0,0.6);z-index:20000;display:flex;align-items:center;gap:10px}

    /* shift modal */
    .shift-modal{position:fixed;left:50%;top:12%;transform:translateX(-50%);background:linear-gradient(180deg,#071022,#07182a);padding:16px;border-radius:12px;width:480px;box-shadow:0 20px 60px rgba(0,0,0,0.6);z-index:20001}
    .shift-options{display:flex;gap:8px;justify-content:space-between}
    .shift-card{flex:1;padding:10px;border-radius:10px;text-align:center;cursor:pointer;border:2px solid transparent}
    .shift-card.selected{border-color:rgba(255,255,255,0.08);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .shift-card img{width:100%;height:120px;object-fit:cover;border-radius:8px}

    /* mini-games */
    .minigame{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:linear-gradient(180deg,#071022,#061426);padding:18px;border-radius:12px;width:640px;max-width:96%;box-shadow:0 30px 80px rgba(2,6,23,0.8);z-index:12000}

    .mini-row{display:flex;gap:8px;margin-top:10px}
    .drag-item{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);cursor:grab}

    .hidden{display:none}

    @media(max-width:980px){.game-wrap{grid-template-columns:1fr}.patient-card{width:100%}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">ME</div>
      <div>
        <h1>M√©dico en Misi√≥n ‚Äî Emergencia Total (v3)</h1>
        <p class="lead">Modo Cl√°sico + Verdadero/Falso, fondo animado, minijuegos y eventos sorpresa. Listo para GitHub Pages.</p>
      </div>
    </header>

    <div class="game-wrap">
      <section class="panel stage" id="stage">
        <!-- animated background layers -->
        <div id="bgDay" class="bg-layer" style="background-image:url('https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?w=1600&q=70&auto=format&fit=crop');opacity:1"></div>
        <div id="bgNight" class="bg-layer" style="background-image:url('https://images.unsplash.com/photo-1505751172876-fa1923c5c528?w=1600&q=70&auto=format&fit=crop');opacity:0"></div>
        <div class="bg-layer overlay"></div>

        <div class="light l1"></div>
        <div class="light l2"></div>
        <div class="light l3"></div>
        <canvas id="particles" class="particles" width="800" height="600"></canvas>

        <div class="stage-header">
          <div class="hud">
            <div class="score">Puntos: <span id="score">0</span></div>
            <div class="small">Nivel: <strong id="levelName">Anatom√≠a</strong></div>
            <div class="small">R√©cord: <strong id="best">0</strong></div>
          </div>
          <div>
            <button class="btn" id="startBtn">Iniciar Partida</button>
            <button class="btn ghost" id="pauseBtn">Pausar</button>
          </div>
        </div>

        <div class="patient-area">
          <div class="patient-card">
            <div class="avatar-wrap">
              <img id="avatarImg" class="avatar-img" src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=1200&q=80&auto=format&fit=crop" alt="Paciente">
              <div class="avatar-gloss"></div>
            </div>

            <div class="vitals">
              <div class="small">Vida del paciente</div>
              <div class="bar" style="margin-top:8px"><i id="patientBar"></i></div>
              <div class="stat-row"><div class="small">Tiempo: <span id="roundTimer">--</span></div><div class="small">Errores: <span id="errors">0</span></div></div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;align-items:center;justify-content:space-between">
              <div>
                <div class="small">Burbujas: <span id="hintsCount">0</span></div>
                <div class="small">Racha: <span id="combo">0</span></div>
              </div>
              <div>
                <button class="btn ghost" id="shiftBtn">Turno</button>
              </div>
            </div>

          </div>

          <div class="stage-canvas" id="stageCanvas">
            <div id="floatingHints" style="position:absolute;left:12px;top:10px;color:var(--muted);font-size:13px;z-index:9">Burbujas: <span id="hintsCount2">0</span></div>
            <div class="doors" id="doors" aria-hidden="true" style="z-index:9">
              <div class="door" id="doorLeft"><div class="label">Hospital</div></div>
              <div class="door" id="doorRight"><div class="label">Entrada</div></div>
            </div>
            <!-- area for spawned items -->
          </div>
        </div>

      </section>

      <aside class="panel controls">
        <h3>Modos & Niveles</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn" id="modeClassic">Modo Cl√°sico</button>
          <button class="btn ghost" id="modeTF">Verdadero/Falso</button>
        </div>

        <div class="level-list">
          <button class="btn ghost levelBtn" data-level="Anatom√≠a">Anatom√≠a</button>
          <button class="btn ghost levelBtn" data-level="Cardiolog√≠a">Cardiolog√≠a</button>
          <button class="btn ghost levelBtn" data-level="Neurolog√≠a">Neurolog√≠a</button>
          <button class="btn ghost levelBtn" data-level="Urgencias">Urgencias</button>
          <button class="btn ghost levelBtn" data-level="Pediatr√≠a">Pediatr√≠a</button>
        </div>

        <div style="margin-top:12px">
          <div class="small">Tiempo por pregunta (s)</div>
          <input id="timePerQ" type="range" min="6" max="40" value="18" style="width:100%">
          <div style="display:flex;justify-content:space-between;color:var(--muted);font-size:13px"><span>6s</span><span id="timeLabel">18s</span><span>40s</span></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="saveBtn">Guardar</button>
          <button class="btn ghost" id="loadBtn">Cargar</button>
        </div>

        <div style="margin-top:12px;color:var(--muted);font-size:13px">
          Consejo: recoge jeringas y burbujas antes de que desaparezcan ‚Äî pueden salvar al paciente.
        </div>

        <div class="achievements">
          <h4 style="margin-top:12px">Logros & Medallas</h4>
          <div id="medalList"></div>
          <div style="margin-top:8px">
            <button class="btn" id="showStats">Estad√≠sticas</button>
          </div>
        </div>
      </aside>
    </div>

    <footer style="margin-top:14px;color:var(--muted);font-size:13px">S√∫belo a GitHub Pages: guarda este archivo como <code>index.html</code> en la ra√≠z del repositorio.</footer>
  </div>

  <!-- Question modal -->
  <div id="qmodal" class="qmodal hidden">
    <div class="qheader"><strong id="qmodeLabel">Pregunta</strong><div class="small">Turno: <span id="activeShift">D√≠a</span></div></div>
    <div class="qtext" id="qtext">Pregunta</div>
    <div class="opts" id="opts"></div>
    <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
      <div class="small">Pista: <span id="qhint" style="color:var(--muted)">---</span></div>
      <div>
        <button class="btn ghost" id="useHint">Usar pista (-2 pts)</button>
        <button class="btn" id="submitClose">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- shift modal -->
  <div id="shiftModal" class="shift-modal hidden">
    <h3>Selecciona turno</h3>
    <div style="margin-top:8px;color:var(--muted);font-size:13px">Elige si jugar√°s de d√≠a o de noche. Esto cambia el fondo y ambiente.</div>
    <div class="shift-options" style="margin-top:12px">
      <div class="shift-card selected" id="shiftDay" data-shift="day"><img src="https://images.unsplash.com/photo-1586773860414-3ef3a7b1b4d7?w=1200&q=70&auto=format&fit=crop" alt="Turno d√≠a"><div style="margin-top:8px">Turno D√≠a</div></div>
      <div class="shift-card" id="shiftNight" data-shift="night"><img src="https://images.unsplash.com/photo-1586773860470-5f9d2a2b5f6a?w=1200&q=70&auto=format&fit=crop" alt="Turno noche"><div style="margin-top:8px">Turno Noche</div></div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn ghost" id="shiftClose">Cerrar</button>
      <button class="btn" id="shiftApply">Aplicar</button>
    </div>
  </div>

  <!-- minigame containers -->
  <div id="minigameRCP" class="minigame hidden">
    <h3>RCP ‚Äî Presiona ESPACIO al ritmo</h3>
    <div style="margin-top:8px;color:var(--muted)">Sigue el pulso. Precisi√≥n alta restaura vida.</div>
    <div style="margin-top:12px" id="rcpBar">Pulsa: <span id="rcpCount">0</span></div>
    <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px"><button class="btn ghost" id="rcpClose">Cerrar</button></div>
  </div>

  <div id="minigameDrag" class="minigame hidden">
    <h3>Diagn√≥stico r√°pido</h3>
    <div style="margin-top:8px;color:var(--muted)">Arrastra el s√≠ntoma al diagn√≥stico correcto.</div>
    <div class="mini-row" id="dragRow" style="margin-top:10px"></div>
    <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px"><button class="btn ghost" id="dragClose">Cerrar</button></div>
  </div>

  <div id="minigameSeq" class="minigame hidden">
    <h3>Cirug√≠a express ‚Äî Ordena los pasos</h3>
    <div style="margin-top:8px;color:var(--muted)">Selecciona los pasos en el orden correcto.</div>
    <div class="mini-row" id="seqRow" style="margin-top:10px"></div>
    <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px"><button class="btn ghost" id="seqClose">Cerrar</button></div>
  </div>

  <script>
    // ------------------ Assets & Data ------------------
    const BG = { day: document.getElementById('bgDay'), night: document.getElementById('bgNight') };
    const AVATARS = { happy: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=1200&q=70&auto=format&fit=crop', neutral: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=1200&q=70&auto=format&fit=crop', critical: 'https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?w=1200&q=70&auto=format&fit=crop' };

    // Expanded questions + True/False sets
    const LEVELS = {
      'Anatom√≠a': [
        {q:'¬øCu√°l es el hueso m√°s largo del cuerpo humano?', a:['H√∫mero','F√©mur','Tibia','Radio'], r:1, hint:'Se encuentra en la pierna'},
        {q:'¬øD√≥nde se producen la mayor parte de las c√©lulas sangu√≠neas?', a:['H√≠gado','M√©dula √≥sea','Bazo','P√°ncreas'], r:1, hint:'√ìrgano productor de c√©lulas sangu√≠neas'},
        {q:'¬øCu√°l es la unidad funcional del ri√±√≥n?', a:['Neurona','Nefrona','Alv√©olo','Osteona'], r:1, hint:'Filtra y reabsorbe en el ri√±√≥n'},
        {q:'¬øCu√°l es el nombre del hueso de la mejilla?', a:['Maxilar','Mand√≠bula','Cigom√°tico','Frontal'], r:2, hint:'Es el cigom√°tico'},
        {q:'¬øD√≥nde est√°n los alveolos?', a:['Pulmones','H√≠gado','Ri√±√≥n','Coraz√≥n'], r:0, hint:'Intercambio de gases'},
        {q:'¬øQu√© estructura conecta huesos entre s√≠?', a:['Tend√≥n','Ligamento','M√∫sculo','Articulaci√≥n'], r:1, hint:'Estabiliza la articulaci√≥n'}
      ],
      'Cardiolog√≠a': [
        {q:'¬øQu√© v√°lvula separa aur√≠cula izquierda y ventr√≠culo izquierdo?', a:['Tric√∫spide','Mitral','Pulmonar','A√≥rtica'], r:1, hint:'Tambi√©n llamada bic√∫spide'},
        {q:'¬øQu√© arteria irriga el miocardio?', a:['Coronaria','Femoral','Cef√°lica','Car√≥tida'], r:0, hint:'Su bloqueo puede causar infarto'},
        {q:'¬øFrecuencia cardiaca normal en adulto en reposo (aprox.)?', a:['30-50','60-100','110-140','140-180'], r:1, hint:'Entre 60 y 100 lpm'},
        {q:'¬øC√≥mo se llama el latido irregular del coraz√≥n?', a:['Taquicardia','Bradicardia','Arritmia','Isquemia'], r:2, hint:'Es una arritmia'},
        {q:'¬øQu√© f√°rmaco se usa en paro para reversi√≥n inicial?', a:['Aspirina','Adrenalina','Atropina','Amoxicilina'], r:1, hint:'Administraci√≥n intramuscular o IV'},
        {q:'¬øQu√© onda del ECG representa la despolarizaci√≥n ventricular?', a:['P','QRS','T','U'], r:1, hint:'QRS es la despolarizaci√≥n ventricular'}
      ],
      'Neurolog√≠a': [
        {q:'¬øQu√© √°rea cerebral es responsable del lenguaje en la mayor√≠a de personas?', a:['√Årea de Broca','Cerebelo','Hipot√°lamo','N√∫cleo caudado'], r:0, hint:'Relacionada con la producci√≥n de habla'},
        {q:'¬øCu√°l es el principal neurotransmisor excitador?', a:['GABA','Glutamato','Dopamina','Serotonina'], r:1, hint:'Abundante en sinapsis excitadoras'},
        {q:'¬øQu√© nervio controla los m√∫sculos de expresi√≥n facial?', a:['Nervio facial (VII)','Trig√©mino (V)','√ìptico (II)','Glosofar√≠ngeo (IX)'], r:0, hint:'Es el VII par craneal'},
        {q:'¬øQu√© estructura se encarga de la coordinaci√≥n motora fina?', a:['Cerebelo','T√°lamo','Hipocampo','Am√≠gdala'], r:0, hint:'El cerebelo coordina movimientos'},
        {q:'¬øQu√© es un accidente cerebrovascular (ACV)?', a:['Infecci√≥n','Hemorragia o isquemia cerebral','Paro cardiaco','Fractura craneal'], r:1, hint:'Interrupci√≥n del flujo sangu√≠neo cerebral'},
        {q:'¬øCu√°l nervio transmite sensaci√≥n de la cara?', a:['Vago (X)','Trig√©mino (V)','Facial (VII)','Olftatorio (I)'], r:1, hint:'Es el V par craneal'}
      ],
      'Urgencias': [
        {q:'En paro cardiaco, la maniobra inmediata es?', a:['RCP','Aspirar v√≠as','Administrar antibi√≥tico','Elevar piernas'], r:0, hint:'Compresiones tor√°cicas y ventilaciones'},
        {q:'Signo de perfusi√≥n deficiente en choque?', a:['Pulsos fuertes','Piel fr√≠a y pegajosa','Mucha sed','Pupilas peque√±as'], r:1, hint:'Signos de mala perfusi√≥n perif√©rica'},
        {q:'Tratamiento inicial para anafilaxia grave?', a:['Antihistam√≠nicos','Adrenalina IM','Antibi√≥tico','Aspirina'], r:1, hint:'Inyecci√≥n intramuscular de emergencia'},
        {q:'¬øQu√© hacer ante una obstrucci√≥n de v√≠as a√©reas completa?', a:['Golpes en la espalda y maniobra de Heimlich','Administrar agua','Elevar piernas','Colocar mascarilla'], r:0, hint:'Heimlich en adultos conscientes'},
        {q:'¬øCu√°l es la prioridad en triage?', a:['Pacientes menos graves','Pacientes con riesgo vital','Pacientes con dolor','Pacientes con fiebre'], r:1, hint:'Priorizar riesgo vital'},
        {q:'¬øQu√© signo indica hemorragia interna masiva?', a:['Hipertermia','Hipotensi√≥n y taquicardia','Piel rosada','Ojos llorosos'], r:1, hint:'Shock hipovol√©mico'}
      ],
      'Pediatr√≠a': [
        {q:'¬øQu√© vacuna previene el t√©tanos?', a:['BCG','Triple viral','DTP','Hepatitis B'], r:2, hint:'Toxoide tet√°nico en DTP'},
        {q:'¬øCu√°l es el signo de deshidrataci√≥n severa en ni√±os?', a:['Lagrimeo','Fontanela hundida','Apetito aumentado','Orina frecuente'], r:1, hint:'Fontanela hundida en lactantes'},
        {q:'¬øA qu√© edad comienzan a aparecer dientes primarios?', a:['0-1 mes','6-12 meses','2-3 a√±os','4-5 a√±os'], r:1, hint:'Entre 6 y 12 meses'],
        {q:'¬øQu√© es la bronquiolitis?', a:['Infecci√≥n viral de v√≠as bajas','Enfermedad renal','Problema dermatol√≥gico','Intoxicaci√≥n'], r:0, hint:'Afecta a lactantes y ni√±os peque√±os'},
        {q:'¬øQu√© l√≠quido es preferible en rehidrataci√≥n oral?', a:['Agua sola','Soluci√≥n de rehidrataci√≥n oral','Leche','Bebidas azucaradas'], r:1, hint:'SRO con electrolitos'},
        {q:'¬øCu√°l es la frecuencia respiratoria normal en lactante?', a:['10-20','30-60','60-100','5-10'], r:1, hint:'Mayor que en adultos'}
      ]
    };

    const TF = [
      {q:'El f√©mur es el hueso m√°s largo del cuerpo.', ans:true},
      {q:'La medula √≥sea no produce c√©lulas sangu√≠neas.', ans:false},
      {q:'La adrenalina se usa en anafilaxia.', ans:true},
      {q:'La bradicardia es un ritmo card√≠aco acelerado.', ans:false},
      {q:'El cerebelo regula la coordinaci√≥n motora.', ans:true},
      {q:'La penicilina es un antiviral.', ans:false},
      {q:'Los alv√©olos est√°n en los pulmones.', ans:true},
      {q:'La hipotensi√≥n es un signo de buen estado circulatorio.', ans:false}
    ];

    // ------------------ State ------------------
    let mode = 'classic'; // 'classic' | 'tf'
    let currentLevel = 'Anatom√≠a';
    let score = 0; let best = Number(localStorage.getItem('me_best')||0);
    let patientHP = 100; const maxHP = 100;
    let qTimer = null; let spawnInterval = null; let patientDrainInterval = null;
    let activeQuestion = null; let playing = false; let hintsAvailable = 0; let errors = 0;
    let combo = 0; let questionsAsked = 0; let sinceLastEvent = 0;

    // achievements
    const ACHS = [
      {id:'first_save', name:'Primer paciente salvado', desc:'Salva tu primer paciente', icon:'üèÖ', unlocked:false},
      {id:'rck_combo', name:'Racha 5', desc:'5 respuestas correctas seguidas', icon:'üî•', unlocked:false},
      {id:'rcp_master', name:'Maestro RCP', desc:'Completar 3 RCP exitosas', icon:'ü´Ä', unlocked:false}
    ];

    // ------------------ DOM refs ------------------
    const scoreEl = document.getElementById('score'); const bestEl = document.getElementById('best');
    const patientBar = document.getElementById('patientBar'); const avatarImg = document.getElementById('avatarImg');
    const stageCanvas = document.getElementById('stageCanvas'); const levelName = document.getElementById('levelName');
    const qmodal = document.getElementById('qmodal'); const qtext = document.getElementById('qtext'); const opts = document.getElementById('opts');
    const qhint = document.getElementById('qhint'); const hintsCount = document.getElementById('hintsCount'); const hintsCount2 = document.getElementById('hintsCount2');
    const roundTimerEl = document.getElementById('roundTimer'); const errorsEl = document.getElementById('errors'); const comboEl = document.getElementById('combo');
    const bgDay = document.getElementById('bgDay'); const bgNight = document.getElementById('bgNight'); const activeShiftEl = document.getElementById('activeShift');

    // minigame refs
    const minigameRCP = document.getElementById('minigameRCP'); const rcpCountEl = document.getElementById('rcpCount');
    const minigameDrag = document.getElementById('minigameDrag'); const dragRow = document.getElementById('dragRow');
    const minigameSeq = document.getElementById('minigameSeq'); const seqRow = document.getElementById('seqRow');

    // ------------------ Utilities ------------------
    function beep(freq=440,dur=0.08,vol=0.02){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(ctx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+dur); setTimeout(()=>{ o.stop(); ctx.close(); }, dur*1000); }catch(e){} }
    function uiUpdate(){ scoreEl.textContent = score; bestEl.textContent = best; patientBar.style.width = patientHP + '%'; levelName.textContent = currentLevel; hintsCount.textContent = hintsAvailable; hintsCount2.textContent = hintsAvailable; errorsEl.textContent = errors; comboEl.textContent = combo; }

    function showToast(text, ms=2800){ const t=document.createElement('div'); t.className='toast'; t.textContent=text; document.body.appendChild(t); setTimeout(()=>t.style.opacity=1,20); setTimeout(()=>{ t.style.opacity=0; setTimeout(()=>t.remove(),400); },ms); }

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } }

    // ------------------ Background & particles ------------------
    function applyShift(s){ localStorage.setItem('me_shift', s); activeShiftEl.textContent = s==='night' ? 'Noche' : 'D√≠a'; if(s==='night'){ bgDay.style.opacity=0; bgNight.style.opacity=1; } else { bgDay.style.opacity=1; bgNight.style.opacity=0; } }
    function ensureShift(){ const s = localStorage.getItem('me_shift') || 'day'; applyShift(s); }

    // particles simple
    const canvas = document.getElementById('particles'); const ctx = canvas.getContext('2d'); let particles=[]; function initParticles(){ const w=canvas.width=stageCanvas.clientWidth; const h=canvas.height=stageCanvas.clientHeight; particles=[]; for(let i=0;i<40;i++){ particles.push({x:Math.random()*w,y:Math.random()*h, r:Math.random()*2+1, vx:(Math.random()-0.5)/4, vy:(Math.random()-0.5)/4, color:`rgba(255,255,255,${Math.random()*0.06+0.02})`}); } }
    function drawParticles(){ ctx.clearRect(0,0,canvas.width,canvas.height); for(const p of particles){ ctx.beginPath(); ctx.fillStyle=p.color; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); p.x+=p.vx; p.y+=p.vy; if(p.x<0) p.x=canvas.width; if(p.x>canvas.width) p.x=0; if(p.y<0) p.y=canvas.height; if(p.y>canvas.height) p.y=0; } requestAnimationFrame(drawParticles); }

    // ------------------ Spawn items ------------------
    function spawnRandomItem(){ if(!playing) return; const types=['syringe','clock','hint']; const t = types[Math.floor(Math.random()*types.length)]; const el=document.createElement('div'); el.className='spawn-item '+t; el.textContent = t==='syringe'? 'üíâ Jeringa' : (t==='clock'?'‚è±Ô∏è Tiempo':'ü´ß Pista'); const x = Math.random()*(stageCanvas.clientWidth-140); const y = 80 + Math.random()*(stageCanvas.clientHeight-260); el.style.left = x+'px'; el.style.top = y+'px'; stageCanvas.appendChild(el);
      let vy=(Math.random()*0.6+0.2)*(Math.random()>0.5?1:-1); const floatInt=setInterval(()=>{ if(!el.parentElement){ clearInterval(floatInt); return; } const curY=parseFloat(el.style.top); el.style.top=(curY+vy)+'px'; if(curY<20||curY>stageCanvas.clientHeight-60) vy*=-1; },180);
      const life=5000+Math.random()*9000; const timeout=setTimeout(()=>{ if(el.parentElement) el.remove(); clearInterval(floatInt); }, life);
      el.addEventListener('click', ()=>{ if(!playing) return; clearTimeout(timeout); clearInterval(floatInt); collectItem(t); el.remove(); }); }

    function collectItem(type){ if(type==='syringe'){ patientHP = Math.min(maxHP, patientHP+25); score += 8; beep(880,0.08); } else if(type==='clock'){ score += 6; beep(720,0.08); if(qTimer){ clearInterval(qTimer); startQuestionTimer((Number(document.getElementById('timePerQ').value) || 18) + 6); } } else if(type==='hint'){ hintsAvailable +=1; score +=4; beep(960,0.08); } uiUpdate(); }
    function clearStageItems(){ stageCanvas.querySelectorAll('.spawn-item').forEach(n=>n.remove()); }

    // ------------------ Patient drain & visual ------------------
    function levelSpeed(lv){ switch(lv){ case 'Anatom√≠a': return 0.6; case 'Cardiolog√≠a': return 0.9; case 'Neurolog√≠a': return 1.4; case 'Urgencias': return 2.2; case 'Pediatr√≠a': return 0.7; default:return 1; } }
    function startPatientDrain(){ if(patientDrainInterval) clearInterval(patientDrainInterval); const speed = levelSpeed(currentLevel); patientDrainInterval = setInterval(()=>{ if(!playing) return; patientHP = Math.max(0, patientHP - speed); avatarImg.style.filter = `grayscale(${Math.max(0, 1 - patientHP/120)}) contrast(${1 - (100-patientHP)/600})`; avatarImg.style.transform = `scale(${1 + (100-patientHP)/2200})`; uiUpdate(); if(patientHP <= 0){ endRound(false); } }, 1200); }

    // ------------------ Questions (classic) ------------------
    function nextClassicQuestion(){ if(!playing) return; if(activeQuestion) return; const pool = LEVELS[currentLevel]; const q = pool[Math.floor(Math.random()*pool.length)]; activeQuestion = JSON.parse(JSON.stringify(q)); showQuestionClassic(activeQuestion); }
    function showQuestionClassic(q){ qmodal.classList.remove('hidden'); document.getElementById('qmodeLabel').textContent='Pregunta (M√∫ltiple)'; document.getElementById('activeShift').textContent = (localStorage.getItem('me_shift')==='night'?'Noche':'D√≠a'); qtext.textContent = q.q; qhint.textContent = '---'; opts.innerHTML=''; const letters=['A','B','C','D']; const arr = q.a.map((t,i)=>({t,i})); shuffle(arr); arr.forEach((o,idx)=>{ const b=document.createElement('div'); b.className='optbtn'; b.dataset.index = o.i; b.innerHTML = `<strong>${letters[idx]})</strong> ${o.t}`; b.addEventListener('click', ()=> chooseAnswer(b)); opts.appendChild(b); }); startQuestionTimer(Number(document.getElementById('timePerQ').value) || 18); }

    function chooseAnswer(btn){ if(!activeQuestion) return; stopQuestionTimer(); const chosen = Number(btn.dataset.index); const correct = chosen === activeQuestion.r; Array.from(opts.children).forEach(o=>o.classList.add('disabled'));
      if(correct){ btn.style.outline='4px solid rgba(16,185,129,0.12)'; combo++; score += 15 * Math.max(1, Math.min(3, combo)); patientHP = Math.min(maxHP, patientHP+18); beep(880,0.08); avatarImg.src = AVATARS.happy; } else { btn.style.outline='4px solid rgba(239,68,68,0.12)'; errors++; patientHP = Math.max(0, patientHP - 14); score = Math.max(0, score - 6); combo = 0; beep(200,0.12); avatarImg.src = AVATARS.critical; }
      questionsAsked++; sinceLastEvent++; uiUpdate(); setTimeout(()=>{ avatarImg.src = AVATARS.neutral; closeQuestion(); if(patientHP<=0) endRound(false); else decideNextAfterQuestion(); },900);
    }

    // ------------------ True/False mode ------------------
    function startTFMode(){ // separate flow
      if(!playing) return; if(activeQuestion) return; const q = TF[Math.floor(Math.random()*TF.length)]; activeQuestion = {tf:true,...q}; showTFQuestion(activeQuestion); }
    function showTFQuestion(q){ qmodal.classList.remove('hidden'); document.getElementById('qmodeLabel').textContent='Verdadero / Falso'; document.getElementById('activeShift').textContent = (localStorage.getItem('me_shift')==='night'?'Noche':'D√≠a'); qtext.textContent = q.q; qhint.textContent = '---'; opts.innerHTML=''; ['Verdadero','Falso'].forEach((t,i)=>{ const b=document.createElement('div'); b.className='optbtn'; b.dataset.tf = (i===0); b.textContent = t; b.addEventListener('click', ()=> chooseTF(b)); opts.appendChild(b); }); startQuestionTimer(Math.max(8, Math.min(15, Number(document.getElementById('timePerQ').value) || 12))); }
    function chooseTF(btn){ if(!activeQuestion) return; stopQuestionTimer(); const chosen = (btn.dataset.tf === 'true'); const correct = chosen === activeQuestion.ans; Array.from(opts.children).forEach(o=>o.classList.add('disabled'));
      if(correct){ combo++; score += 12 * Math.max(1, Math.min(3, combo)); patientHP = Math.min(maxHP, patientHP+12); beep(880,0.08); avatarImg.src = AVATARS.happy; } else { errors++; patientHP = Math.max(0, patientHP - 12); score = Math.max(0, score - 6); combo = 0; beep(200,0.12); avatarImg.src = AVATARS.critical; }
      questionsAsked++; sinceLastEvent++; uiUpdate(); setTimeout(()=>{ avatarImg.src = AVATARS.neutral; closeQuestion(); if(patientHP<=0) endRound(false); else decideNextAfterQuestion(); },700);
    }

    function startQuestionTimer(seconds){ if(qTimer) clearInterval(qTimer); let t=seconds; roundTimerEl.textContent = t+'s'; qTimer = setInterval(()=>{ t--; roundTimerEl.textContent = t+'s'; if(t<=4) roundTimerEl.style.color='orange'; if(t<=2) roundTimerEl.style.color='red'; if(t<=0){ clearInterval(qTimer); qTimer=null; errors++; patientHP = Math.max(0, patientHP - 14); score = Math.max(0, score - 5); combo = 0; beep(220,0.12); uiUpdate(); closeQuestion(); if(patientHP<=0) endRound(false); else setTimeout(()=> decideNextAfterQuestion(),800); } },1000); }
    function stopQuestionTimer(){ if(qTimer) clearInterval(qTimer); qTimer=null; roundTimerEl.textContent='--'; roundTimerEl.style.color='inherit'; }
    function closeQuestion(){ qmodal.classList.add('hidden'); activeQuestion=null; stopQuestionTimer(); }

    // ------------------ After question logic, events & minigames ------------------
    function decideNextAfterQuestion(){ uiUpdate(); // check surprise event every 5 questions
      if(questionsAsked>0 && questionsAsked % 5 ===0){ // 30% chance
        if(Math.random()<0.3){ triggerSurprise(); return; } }
      // spawn minigame occasionally: 1 in 6
      if(Math.random()<0.16){ triggerRandomMinigame(); return; }
      // else next question based on mode
      if(mode==='classic') setTimeout(()=> nextClassicQuestion(), 700); else setTimeout(()=> startTFMode(),700);
    }

    // Surprise events
    function triggerSurprise(){ const events = ['blackout','expert','allergy','rush']; const e = events[Math.floor(Math.random()*events.length)]; if(e==='blackout'){ // darken background
        document.querySelector('.bg-layer.overlay').style.transition='filter .2s ease,opacity .2s ease'; document.querySelector('.bg-layer.overlay').style.background='linear-gradient(180deg,rgba(0,0,0,0.85),rgba(0,0,0,0.9))'; showToast('‚ö†Ô∏è Apag√≥n ‚Äî luces reducidas 6s',3500); setTimeout(()=>{ document.querySelector('.bg-layer.overlay').style.background='linear-gradient(180deg,rgba(10,20,30,0.4),rgba(2,6,12,0.5))'; },6000);
      } else if(e==='expert'){ hintsAvailable +=1; uiUpdate(); showToast('üë®‚Äç‚öïÔ∏è M√©dico experto llega ‚Äî Pista gratis a√±adida',3000); } else if(e==='allergy'){ patientHP = Math.max(0, patientHP - 10); uiUpdate(); showToast('‚ö†Ô∏è Reacci√≥n al√©rgica ‚Äî -10 HP',3000); } else if(e==='rush'){ // next question time reduced
        showToast('‚è±Ô∏è Nueva emergencia ‚Äî tiempo reducido en la pr√≥xima pregunta',3000); const input = document.getElementById('timePerQ'); input.dataset.tempReduce = '6'; setTimeout(()=>{ delete input.dataset.tempReduce; },6000);
      } }

    // ------------------ Minigames ------------------
    // RCP: press space at rhythm (simulate beats)
    let rcpActive=false; let rcpCount=0; let rcpTarget=8; function triggerRCP(){ rcpActive=true; rcpCount=0; rcpTarget = 6 + Math.floor(Math.random()*5); rcpCountEl.textContent='0/'+rcpTarget; minigameRCP.classList.remove('hidden'); showToast('Minijuego: RCP ‚Äî ¬°Presiona ESPACIO!',2500); }
    function stopRCP(success){ rcpActive=false; minigameRCP.classList.add('hidden'); if(success){ patientHP = Math.min(maxHP, patientHP + 20); score += 20; showToast('‚úÖ RCP exitosa ‚Äî +20 HP',2200); } else { patientHP = Math.max(0, patientHP - 8); showToast('‚ùå RCP incompleta ‚Äî -8 HP',2200); } uiUpdate(); }

    // Drag diagnosis
    function triggerDrag(){ minigameDrag.classList.remove('hidden'); dragRow.innerHTML=''; const pairs = [ ['Fiebre','Infecci√≥n'], ['Dolor tor√°cico','Infarto'], ['Hemorragia','Trauma'], ['Dificultad respiratoria','Asma'] ]; shuffle(pairs); const left = pairs.map(p=>p[0]); const right = pairs.map(p=>p[1]); for(const s of left){ const d = document.createElement('div'); d.className='drag-item'; d.draggable=true; d.textContent=s; d.addEventListener('dragstart',(ev)=>{ ev.dataTransfer.setData('text/plain',s); }); dragRow.appendChild(d); }
      const dropZone = document.createElement('div'); dropZone.style.display='flex'; dropZone.style.gap='8px'; dropZone.style.marginLeft='10px'; right.forEach(r=>{ const z=document.createElement('div'); z.className='drag-item'; z.style.minWidth='120px'; z.textContent=r; z.addEventListener('dragover',(ev)=>ev.preventDefault()); z.addEventListener('drop',(ev)=>{ const s = ev.dataTransfer.getData('text/plain'); // check pair
          const correct = pairs.some(p=>p[0]===s && p[1]===r);
          if(correct){ score += 10; showToast('‚úÖ Diagn√≥stico correcto +10 pts',2000); minigameDrag.classList.add('hidden'); uiUpdate(); } else { patientHP = Math.max(0, patientHP - 6); showToast('‚ùå Incorrecto -6 HP',2000); minigameDrag.classList.add('hidden'); uiUpdate(); } }); dropZone.appendChild(z); }); dragRow.appendChild(dropZone);
    }

    // Sequence surgery
    function triggerSeq(){ minigameSeq.classList.remove('hidden'); seqRow.innerHTML=''; const steps = ['Esterilizar','Incisi√≥n','Control sangrado','Suturar','Vendaje']; const shuffled = [...steps]; shuffle(shuffled); for(const s of shuffled){ const b=document.createElement('div'); b.className='drag-item'; b.textContent=s; b.addEventListener('click', ()=>{ // collect seq
          if(!b.dataset.selected){ b.dataset.selected='1'; b.style.opacity=.6; b.style.transform='translateY(-6px)'; const chosen = document.querySelectorAll('#seqRow .drag-item.selected'); if(chosen.length===steps.length){ // evaluate
              const picked = Array.from(document.querySelectorAll('#seqRow .drag-item')).filter(x=>x.dataset.selected).map(x=>x.textContent);
              const ok = picked.join('|') === steps.join('|'); if(ok){ score += 25; showToast('‚úÖ Cirug√≠a correcta +25 pts',2400); } else { patientHP = Math.max(0, patientHP - 12); showToast('‚ùå Orden incorrecto -12 HP',2400); } minigameSeq.classList.add('hidden'); uiUpdate(); }
          }}); seqRow.appendChild(b); }
    }

    function triggerRandomMinigame(){ const r = Math.random(); if(r<0.33) triggerRCP(); else if(r<0.66) triggerDrag(); else triggerSeq(); }

    // keyboard for RCP
    window.addEventListener('keydown',(e)=>{ if(rcpActive && e.code==='Space'){ e.preventDefault(); rcpCount++; rcpCountEl.textContent = rcpCount + '/' + rcpTarget; beep(900,0.04,0.02); if(rcpCount>=rcpTarget){ stopRCP(true); } } });

    document.getElementById('rcpClose').addEventListener('click', ()=>{ if(rcpActive) stopRCP(rcpCount>=Math.floor(rcpTarget/1.6)); });
    document.getElementById('dragClose').addEventListener('click', ()=>{ minigameDrag.classList.add('hidden'); });
    document.getElementById('seqClose').addEventListener('click', ()=>{ minigameSeq.classList.add('hidden'); });

    // ------------------ Achievements ------------------
    function loadAchievements(){ const raw = localStorage.getItem('me_achs'); if(raw){ const saved = JSON.parse(raw); ACHS.forEach(a=>{ a.unlocked = !!saved[a.id]; }); } renderMedals(); }
    function saveAchievements(){ const obj={}; ACHS.forEach(a=>{ if(a.unlocked) obj[a.id]=true; }); localStorage.setItem('me_achs', JSON.stringify(obj)); }
    function renderMedals(){ const el=document.getElementById('medalList'); el.innerHTML=''; ACHS.forEach(a=>{ const d=document.createElement('div'); d.className='medal' + (a.unlocked?'':' locked'); d.innerHTML = `<div style="font-size:20px">${a.icon}</div><div><strong>${a.name}</strong><div style="font-size:12px;color:var(--muted)">${a.desc}</div></div>`; el.appendChild(d); }); }
    function unlock(id){ const a = ACHS.find(x=>x.id===id); if(!a || a.unlocked) return; a.unlocked = true; saveAchievements(); renderMedals(); showToast(`üèÖ Nuevo logro: ${a.name}`,3000); }

    // ------------------ End round & control ------------------
    function endRound(win){ stopAll(); clearStageItems(); playing=false; stopQuestionTimer(); activeQuestion=null; if(win){ score += 40; beep(1200,0.12); setTimeout(()=>alert('‚úÖ Paciente salvado! ‚Äî Puntaje: '+score),200); } else { beep(160,0.18); setTimeout(()=>alert('‚ùå El paciente no sobrevivi√≥. Puntaje: '+score),200); } // achievements
      if(win) unlock('first_save'); uiUpdate(); saveBest(); }

    function saveBest(){ if(score>best){ best = score; localStorage.setItem('me_best', best); } }
    function resetGame(){ stopAll(); score=0; patientHP=maxHP; hintsAvailable=0; errors=0; activeQuestion=null; playing=false; combo=0; questionsAsked=0; sinceLastEvent=0; uiUpdate(); }
    function startGame(){ if(playing) return; playEntranceAnimation(()=>{ playing=true; score=0; patientHP=maxHP; hintsAvailable=0; errors=0; combo=0; questionsAsked=0; sinceLastEvent=0; uiUpdate(); startSpawn(); startPatientDrain(); // start according to mode
        if(mode==='classic') nextClassicQuestion(); else startTFMode(); saveBest(); }); }
    function stopAll(){ if(spawnInterval) clearInterval(spawnInterval); if(qTimer) clearInterval(qTimer); if(patientDrainInterval) clearInterval(patientDrainInterval); spawnInterval=null; qTimer=null; patientDrainInterval=null; }
    function startSpawn(){ if(spawnInterval) clearInterval(spawnInterval); spawnInterval = setInterval(()=>{ spawnRandomItem(); }, 2300); }

    // Entrance animation
    const doors = document.getElementById('doors'); const doorLeft = document.getElementById('doorLeft'); const doorRight = document.getElementById('doorRight');
    function playEntranceAnimation(callback){ doors.style.display='flex'; setTimeout(()=>{ doorLeft.classList.add('open-left'); doorRight.classList.add('open-right'); setTimeout(()=>{ beep(440,0.12,0.03); setTimeout(()=>{ beep(660,0.08,0.02); if(callback) callback(); },180); },300); },80); setTimeout(()=>{ doors.style.display='none'; },1600); }

    // ------------------ Save & Load ------------------
    document.getElementById('saveBtn').addEventListener('click', ()=>{ const data={mode,currentLevel,score,patientHP,errors,hintsAvailable}; localStorage.setItem('me_save', JSON.stringify(data)); alert('Progreso guardado.'); });
    document.getElementById('loadBtn').addEventListener('click', ()=>{ const raw = localStorage.getItem('me_save'); if(!raw){ alert('No hay progreso guardado.'); return; } const d = JSON.parse(raw); mode=d.mode||mode; currentLevel=d.currentLevel||currentLevel; score=d.score||0; patientHP=d.patientHP||100; errors=d.errors||0; hintsAvailable=d.hintsAvailable||0; levelName.textContent=currentLevel; uiUpdate(); alert('Progreso cargado.'); });

    // ------------------ UI bindings ------------------
    document.getElementById('startBtn').addEventListener('click', ()=> startGame());
    document.getElementById('pauseBtn').addEventListener('click', ()=>{ if(!playing) return; playing=false; stopAll(); stopQuestionTimer(); alert('Juego pausado. Pulsa Iniciar para continuar.'); });
    document.getElementById('submitClose').addEventListener('click', ()=> closeQuestion());
    document.getElementById('timePerQ').addEventListener('input',(e)=>{ document.getElementById('timeLabel').textContent = e.target.value+'s'; });

    document.getElementById('modeClassic').addEventListener('click', ()=>{ mode='classic'; document.getElementById('modeClassic').classList.remove('ghost'); document.getElementById('modeTF').classList.add('ghost'); showToast('Modo Cl√°sico seleccionado',1200); });
    document.getElementById('modeTF').addEventListener('click', ()=>{ mode='tf'; document.getElementById('modeClassic').classList.add('ghost'); document.getElementById('modeTF').classList.remove('ghost'); showToast('Modo Verdadero/Falso seleccionado',1200); });

    document.querySelectorAll('.levelBtn').forEach(b=>{ b.addEventListener('click', ()=>{ currentLevel=b.dataset.level; levelName.textContent=currentLevel; resetGame(); uiUpdate(); showToast('Nivel: '+currentLevel,1200); }); });

    document.getElementById('shiftBtn').addEventListener('click', ()=>{ document.getElementById('shiftModal').classList.remove('hidden'); });
    const shiftDay = document.getElementById('shiftDay'); const shiftNight = document.getElementById('shiftNight'); shiftDay.addEventListener('click', ()=>{ shiftDay.classList.add('selected'); shiftNight.classList.remove('selected'); }); shiftNight.addEventListener('click', ()=>{ shiftNight.classList.add('selected'); shiftDay.classList.remove('selected'); });
    document.getElementById('shiftClose').addEventListener('click', ()=>{ document.getElementById('shiftModal').classList.add('hidden'); });
    document.getElementById('shiftApply').addEventListener('click', ()=>{ const s = shiftDay.classList.contains('selected') ? 'day' : (shiftNight.classList.contains('selected') ? 'night' : null); if(s){ applyShift(s); document.getElementById('shiftModal').classList.add('hidden'); } else alert('Selecciona un turno.'); });

    document.getElementById('useHint').addEventListener('click', ()=>{ if(!activeQuestion) return; if(hintsAvailable<=0){ alert('No tienes burbujas de pista. Recoge burbujas rosas en la sala.'); return; } const optElems = Array.from(opts.children).filter(o=>!o.classList.contains('disabled')); const wrongs = optElems.filter(o=>o.dataset.index && Number(o.dataset.index)!==activeQuestion.r); if(wrongs.length){ const rEl = wrongs[Math.floor(Math.random()*wrongs.length)]; rEl.classList.add('disabled'); hintsAvailable -=1; score = Math.max(0, score-2); uiUpdate(); qhint.textContent = activeQuestion.hint || '...'; } });

    document.getElementById('showStats').addEventListener('click', ()=>{ const stats = JSON.parse(localStorage.getItem('me_stats')||'{}'); alert('Estad√≠sticas:\n' + Object.entries(stats).map(([k,v])=>`${k}: ${v}`).join('\n')); });

    // ------------------ init ------------------
    function init(){ ensureShift(); initParticles(); drawParticles(); loadAchievements(); avatarImg.src = AVATARS.neutral; uiUpdate(); // resize canvas
      window.addEventListener('resize', ()=>{ initParticles(); }); }

    function applyShift(s){ localStorage.setItem('me_shift', s); document.getElementById('activeShift').textContent = s==='night' ? 'Noche' : 'D√≠a'; if(s==='night'){ bgDay.style.opacity=0; bgNight.style.opacity=1; } else { bgDay.style.opacity=1; bgNight.style.opacity=0; } }

    // expose for debugging
    window._medico_v3 = { startGame, resetGame: resetGame, triggerRandomMinigame };

    // start
    init();
  </script>
</body>
</html>
