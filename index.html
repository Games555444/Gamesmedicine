<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M√©dico en Misi√≥n ‚Äî Sala de Urgencias (v2)</title>
  <meta name="description" content="Versi√≥n 2.0: est√©tica mejorada, fondo realista, avatar fotogr√°fico reactivo, turno d√≠a/noche, logros y medallas." />
  <style>
    :root{
      --bg:#051226;--panel:#071728;--accent:#06b6d4;--accent2:#7c3aed;--muted:#b6c7d6;--good:#10b981;--bad:#ef4444;--glass:rgba(255,255,255,0.04);
      --max-width:1200px; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; color: #e8f0f8;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);}
    .app{max-width:var(--max-width);margin:18px auto;padding:18px}

    header{display:flex;align-items:center;gap:12px}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    /* layout */
    .game-wrap{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:16px}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 12px 30px rgba(2,6,23,0.6);backdrop-filter: blur(6px)}

    /* Stage with realistic background */
    .stage{position:relative;min-height:680px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    .stage-bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:brightness(.68) saturate(.9);transition:filter .6s ease}
    .stage-overlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(3,8,16,0.35), rgba(2,6,20,0.45));pointer-events:none}

    .stage-header{position:relative;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;z-index:6}
    .hud{display:flex;gap:12px;align-items:center}
    .score{font-weight:800}
    .small{font-size:13px;color:var(--muted)}

    .patient-area{display:flex;gap:18px;padding:14px;position:relative;z-index:6}
    .patient-card{width:360px;background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}

    /* realistic avatar */
    .avatar-wrap{width:100%;height:260px;border-radius:10px;overflow:hidden;position:relative;background:linear-gradient(180deg,#051826,#02101a);display:flex;align-items:center;justify-content:center}
    .avatar-img{width:100%;height:100%;object-fit:cover;display:block;transform-origin:center center;transition:transform .6s ease, filter .4s ease}
    .avatar-gloss{position:absolute;inset:0;pointer-events:none;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);mix-blend-mode:overlay}

    .vitals{margin-top:12px}
    .bar{height:18px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--good),#60a5fa);width:100%;transition:width .5s ease}
    .stat-row{display:flex;justify-content:space-between;margin-top:8px;color:var(--muted);font-size:13px}

    .stage-canvas{flex:1;position:relative;border-radius:8px;margin:12px;padding:18px;overflow:hidden;display:flex;flex-direction:column}

    .spawn-item{position:absolute;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.06);backdrop-filter:blur(4px);cursor:pointer;border:1px solid rgba(255,255,255,0.03);font-weight:700;user-select:none;transition:transform .12s ease}
    .spawn-item:active{transform:scale(.95)}
    .spawn-item.syringe{background:linear-gradient(90deg,#ecfccb,#bbf7d0);color:#07211a}
    .spawn-item.clock{background:linear-gradient(90deg,#e0f2fe,#bae6fd);color:#052032}
    .spawn-item.hint{background:linear-gradient(90deg,#fee2e2,#fecaca);color:#2b0a0a}

    /* entrance doors */
    .doors{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;z-index:9999}
    .door{flex:1;background:linear-gradient(180deg,#0b1220,#0f2130);display:flex;align-items:center;justify-content:center;transition:transform 900ms cubic-bezier(.2,.9,.2,1)}
    .door .label{color:var(--muted);font-size:28px;opacity:.6}
    .door.open-left{transform:translateX(-105%)}
    .door.open-right{transform:translateX(105%)}

    /* question modal */
    .qmodal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:linear-gradient(180deg,#071022,#07182a);padding:18px;border-radius:12px;width:640px;max-width:92%;box-shadow:0 30px 80px rgba(2,6,23,0.8);z-index:10002;}
    .qmodal .qtext{font-size:18px;margin-bottom:12px}
    .opts{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .optbtn{padding:12px;border-radius:10px;background:var(--glass);cursor:pointer;border:1px solid rgba(255,255,255,0.03);font-weight:700}
    .optbtn.disabled{opacity:.45;pointer-events:none}

    /* right panel */
    aside.controls{position:sticky;top:18px;height:fit-content}
    .controls h3{margin:6px 0 8px}
    .btn{display:inline-block;padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:white;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .level-list{display:flex;flex-direction:column;gap:8px}

    /* achievements panel */
    .achievements{margin-top:12px}
    .medal{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03)}
    .medal img{width:44px;height:44px;border-radius:8px}
    .medal.locked{opacity:.45}

    /* toast */
    .toast{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,#0b1220,#07202f);padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 30px rgba(0,0,0,0.6);z-index:20000;display:flex;align-items:center;gap:10px}

    /* shift modal */
    .shift-modal{position:fixed;left:50%;top:12%;transform:translateX(-50%);background:linear-gradient(180deg,#071022,#07182a);padding:16px;border-radius:12px;width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.6);z-index:20001}
    .shift-options{display:flex;gap:8px;justify-content:space-between}
    .shift-card{flex:1;padding:12px;border-radius:10px;text-align:center;cursor:pointer;border:2px solid transparent}
    .shift-card.selected{border-color:rgba(255,255,255,0.08);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .shift-card img{width:100%;height:120px;object-fit:cover;border-radius:8px}

    .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:700}

    /* responsive */
    @media(max-width:980px){.game-wrap{grid-template-columns:1fr}.patient-card{width:100%}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">ME</div>
      <div>
        <h1>M√©dico en Misi√≥n ‚Äî Sala de Urgencias (v2)</h1>
        <p class="lead">Ahora con fondo realista, avatar fotogr√°fico reactivo, selecci√≥n de turno y sistema de logros.</p>
      </div>
    </header>

    <div class="game-wrap">
      <section class="panel stage" id="stage">
        <!-- realistic background (swapped day/night) -->
        <div class="stage-bg" id="stageBg"></div>
        <div class="stage-overlay"></div>

        <div class="stage-header">
          <div class="hud">
            <div class="score">Puntos: <span id="score">0</span></div>
            <div class="small">Nivel: <strong id="levelName">Anatom√≠a</strong></div>
            <div class="small">R√©cord: <strong id="best">0</strong></div>
          </div>
          <div>
            <button class="btn" id="startBtn">Iniciar Partida</button>
            <button class="btn ghost" id="pauseBtn">Pausar</button>
          </div>
        </div>

        <div class="patient-area">
          <div class="patient-card">
            <div class="avatar-wrap">
              <!-- placeholder avatar images: reempl√°zalas por las tuyas si quieres -->
              <img id="avatarImg" class="avatar-img" src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=1200&q=80&auto=format&fit=crop" alt="Paciente" />
              <div class="avatar-gloss"></div>
            </div>

            <div class="vitals">
              <div class="small">Vida del paciente</div>
              <div class="bar" style="margin-top:8px"><i id="patientBar"></i></div>
              <div class="stat-row"><div class="small">Tiempo: <span id="roundTimer">--</span></div><div class="small">Errores: <span id="errors">0</span></div></div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;align-items:center;justify-content:space-between">
              <div>
                <div class="small">Burbujas: <span id="hintsCount">0</span></div>
                <div class="small">Racha: <span id="combo">0</span></div>
              </div>
              <div>
                <button class="btn ghost" id="shiftBtn">Cambiar Turno</button>
              </div>
            </div>

          </div>

          <div class="stage-canvas" id="stageCanvas">
            <div id="floatingHints" style="position:absolute;left:12px;top:10px;color:var(--muted);font-size:13px;z-index:6">Burbujas: <span id="hintsCount2">0</span></div>
            <!-- doors overlay for intro animation -->
            <div class="doors" id="doors" aria-hidden="true" style="z-index:9">
              <div class="door" id="doorLeft"><div class="label">Hospital</div></div>
              <div class="door" id="doorRight"><div class="label">Entrada</div></div>
            </div>

            <!-- achievements notification area (z-index high) -->

          </div>
        </div>

      </section>

      <aside class="panel controls">
        <h3>Controles & Niveles</h3>
        <div class="level-list">
          <button class="btn ghost levelBtn" data-level="Anatom√≠a">Anatom√≠a (F√°cil)</button>
          <button class="btn ghost levelBtn" data-level="Cardiolog√≠a">Cardiolog√≠a (Medio)</button>
          <button class="btn ghost levelBtn" data-level="Neurolog√≠a">Neurolog√≠a (Dif√≠cil)</button>
          <button class="btn ghost levelBtn" data-level="Urgencias">Urgencias (Pro)</button>
        </div>

        <div style="margin-top:12px">
          <div class="small">Tiempo por pregunta (s)</div>
          <input id="timePerQ" type="range" min="8" max="40" value="18" style="width:100%">
          <div style="display:flex;justify-content:space-between;color:var(--muted);font-size:13px"><span>8s</span><span id="timeLabel">18s</span><span>40s</span></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="saveBtn">Guardar</button>
          <button class="btn ghost" id="loadBtn">Cargar</button>
        </div>

        <div style="margin-top:12px;color:var(--muted);font-size:13px">
          Consejo: recoge jeringas y burbujas antes de que desaparezcan ‚Äî pueden salvar al paciente.
        </div>

        <div class="achievements">
          <h4 style="margin-top:12px">Logros & Medallas</h4>
          <div id="medalList">
            <!-- medals rendered here -->
          </div>
          <div style="margin-top:8px">
            <button class="btn" id="showStats">Estad√≠sticas</button>
          </div>
        </div>
      </aside>
    </div>

    <footer style="margin-top:14px;color:var(--muted);font-size:13px">Sube este archivo a GitHub y act√≠valo con GitHub Pages para compartir el juego.</footer>
  </div>

  <!-- Question modal (hidden until needed) -->
  <div id="qmodal" class="qmodal" style="display:none">
    <div class="qtext" id="qtext">Pregunta</div>
    <div class="opts" id="opts"></div>
    <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
      <div class="small">Pista: <span id="qhint" style="color:var(--muted)">---</span></div>
      <div>
        <button class="btn ghost" id="useHint">Usar pista (-2 pts)</button>
        <button class="btn" id="submitClose">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- shift modal (choose day/night) -->
  <div id="shiftModal" class="shift-modal" style="display:none">
    <h3>Selecciona turno</h3>
    <div style="margin-top:8px;color:var(--muted);font-size:13px">Elige si jugar√°s de d√≠a o de noche. Esto cambia el fondo y ambiente.</div>
    <div class="shift-options" style="margin-top:12px">
      <div class="shift-card" id="shiftDay" data-shift="day">
        <img src="https://images.unsplash.com/photo-1586773860414-3ef3a7b1b4d7?w=1200&q=70&auto=format&fit=crop" alt="Turno d√≠a">
        <div style="margin-top:8px">Turno D√≠a</div>
      </div>
      <div class="shift-card" id="shiftNight" data-shift="night">
        <img src="https://images.unsplash.com/photo-1586773860470-5f9d2a2b5f6a?w=1200&q=70&auto=format&fit=crop" alt="Turno noche">
        <div style="margin-top:8px">Turno Noche</div>
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn ghost" id="shiftClose">Cerrar</button>
      <button class="btn" id="shiftApply">Aplicar</button>
    </div>
  </div>

  <!-- toast container (created dynamically) -->

  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      // ---------- Data & assets ----------
      const BG = {
        day: "https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?w=1600&q=70&auto=format&fit=crop",
        night: "https://images.unsplash.com/photo-1505751172876-fa1923c5c528?w=1600&q=70&auto=format&fit=crop"
      };
      // avatar variations (replaceable)
      const AVATARS = {
        happy: "https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=1200&q=70&auto=format&fit=crop",
        neutral: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=1200&q=70&auto=format&fit=crop",
        critical: "https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?w=1200&q=70&auto=format&fit=crop"
      };

      // questions (same as before) - keep for demo
      const LEVELS = {
        'Anatom√≠a': [
          {q:'¬øCu√°l es el hueso m√°s largo del cuerpo humano?', a:['H√∫mero','F√©mur','Tibia','Radio'], r:1, hint:'Se encuentra en la pierna'},
          {q:'¬øD√≥nde se producen la mayor parte de las c√©lulas sangu√≠neas?', a:['H√≠gado','M√©dula √≥sea','Bazo','P√°ncreas'], r:1, hint:'√ìrgano productor de c√©lulas sangu√≠neas'},
          {q:'¬øCu√°l es la unidad funcional del ri√±√≥n?', a:['Neurona','Nefrona','Alv√©olo','Osteona'], r:1, hint:'Filtra y reabsorbe en el ri√±√≥n'}
        ],
        'Cardiolog√≠a': [
          {q:'¬øCu√°l v√°lvula separa aur√≠cula izquierda y ventr√≠culo izquierdo?', a:['Tric√∫spide','Mitral','Pulmonar','A√≥rtica'], r:1, hint:'Tambi√©n llamada bic√∫spide'},
          {q:'¬øQu√© arteria irriga el miocardio?', a:['Coronaria','Femoral','Cef√°lica','Car√≥tida'], r:0, hint:'Su bloqueo puede causar infarto'},
          {q:'¬øFrecuencia cardiaca normal en adulto en reposo (aprox.)?', a:['30-50','60-100','110-140','140-180'], r:1, hint:'Entre 60 y 100 lpm'}
        ],
        'Neurolog√≠a': [
          {q:'¬øQu√© √°rea cerebral es responsable del lenguaje en la mayor√≠a de personas?', a:['√Årea de Broca','Cerebelo','Hipot√°lamo','N√∫cleo caudado'], r:0, hint:'Relacionada con la producci√≥n de habla'},
          {q:'¬øCu√°l es el principal neurotransmisor excitador?', a:['GABA','Glutamato','Dopamina','Serotonina'], r:1, hint:'Abundante en sinapsis excitadoras'},
          {q:'¬øQu√© nervio controla los m√∫sculos de expresi√≥n facial?', a:['Nervio facial (VII)','Trig√©mino (V)','√ìptico (II)','Glosofar√≠ngeo (IX)'], r:0, hint:'Es el VII par craneal'}
        ],
        'Urgencias': [
          {q:'En paro cardiaco, la maniobra inmediata es?', a:['RCP','Aspirar v√≠as','Administrar antibi√≥tico','Elevar piernas'], r:0, hint:'Compresiones tor√°cicas y ventilaciones'},
          {q:'Signo de perfusi√≥n deficiente en choque?', a:['Pulsos fuertes','Piel fr√≠a y pegajosa','Mucha sed','Pupilas peque√±as'], r:1, hint:'Signos de mala perfusi√≥n perif√©rica'},
          {q:'Tratamiento inicial para anafilaxia grave?', a:['Antihistam√≠nicos','Adrenalina IM','Antibi√≥tico','Aspirina'], r:1, hint:'Inyecci√≥n intramuscular de emergencia'}
        ]
      };

      // ---------- State ----------
      let currentLevel = 'Anatom√≠a';
      let score = 0; let best = Number(localStorage.getItem('me_best')||0);
      let patientHP = 100; const maxHP = 100;
      let qTimer = null; let spawnInterval = null; let patientDrainInterval = null;
      let activeQuestion = null; let playing = false; let hintsAvailable = 0; let errors = 0;
      let combo = 0; let savedStats = JSON.parse(localStorage.getItem('me_stats')||'{}');
      let shift = localStorage.getItem('me_shift') || null; // day | night or null

      // achievements config
      const ACHS = [
        {id:'first_save', name:'Primer paciente salvado', desc:'Salva tu primer paciente', icon:'üèÖ', unlocked:false},
        {id:'three_saves', name:'Rescatista x3', desc:'Salva 3 pacientes en total', icon:'ü•à', unlocked:false},
        {id:'jeringa_master', name:'Mano precisa', desc:'Usa 10 jeringas', icon:'üíâ', unlocked:false},
        {id:'combo_5', name:'Racha caliente', desc:'Responde correctamente 5 seguidas', icon:'üî•', unlocked:false},
        {id:'score_50', name:'Doctor Decano', desc:'Alcanza 50 puntos en una partida', icon:'üéñÔ∏è', unlocked:false}
      ];

      // ---------- DOM refs ----------
      const scoreEl = document.getElementById('score'); const bestEl = document.getElementById('best');
      const patientBar = document.getElementById('patientBar'); const avatarImg = document.getElementById('avatarImg');
      const stageCanvas = document.getElementById('stageCanvas'); const levelName = document.getElementById('levelName');
      const qmodal = document.getElementById('qmodal'); const qtext = document.getElementById('qtext'); const opts = document.getElementById('opts');
      const qhint = document.getElementById('qhint'); const hintsCount = document.getElementById('hintsCount'); const hintsCount2 = document.getElementById('hintsCount2');
      const roundTimerEl = document.getElementById('roundTimer'); const errorsEl = document.getElementById('errors'); const comboEl = document.getElementById('combo');
      const doors = document.getElementById('doors'); const doorLeft = document.getElementById('doorLeft'); const doorRight = document.getElementById('doorRight');
      const stageBg = document.getElementById('stageBg'); const shiftModal = document.getElementById('shiftModal');
      const shiftDay = document.getElementById('shiftDay'); const shiftNight = document.getElementById('shiftNight');

      // ---------- audio beep (simple) ----------
      function beep(freq=440,dur=0.08,vol=0.02){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(ctx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+dur); setTimeout(()=>{ o.stop(); ctx.close(); }, dur*1000); }catch(e){} }

      // ---------- UI helpers ----------
      function uiUpdate(){ scoreEl.textContent = score; bestEl.textContent = best; patientBar.style.width = patientHP + '%'; levelName.textContent = currentLevel; hintsCount.textContent = hintsAvailable; hintsCount2.textContent = hintsAvailable; errorsEl.textContent = errors; comboEl.textContent = combo; }

      // set shift background
      function applyShift(s){ shift = s; localStorage.setItem('me_shift', s); stageBg.style.backgroundImage = `url(${s==='night'?BG.night:BG.day})`; // subtle color tweak
        if(s==='night'){ stageBg.style.filter='brightness(.54) saturate(.82)'; } else { stageBg.style.filter='brightness(.78) saturate(1)'; } }

      // if no shift set, open modal at start
      function ensureShift(){ if(!shift){ shiftModal.style.display='block'; } else applyShift(shift); }

      // ---------- entrance animation ----------
      function playEntranceAnimation(callback){ doors.style.display='flex'; setTimeout(()=>{ doorLeft.classList.add('open-left'); doorRight.classList.add('open-right'); setTimeout(()=>{ beep(440,0.12,0.03); setTimeout(()=>{ beep(660,0.08,0.02); if(callback) callback(); },180); },300); },80); setTimeout(()=>{ doors.style.display='none'; },1600); }

      // ---------- score & stats ----------
      function saveBest(){ if(score>best){ best=score; localStorage.setItem('me_best', best); } }
      function addStat(key, n=1){ savedStats[key] = (savedStats[key]||0)+n; localStorage.setItem('me_stats', JSON.stringify(savedStats)); }

      // ---------- spawn items ----------
      function spawnRandomItem(){ if(!playing) return; const types=['syringe','clock','hint']; const t = types[Math.floor(Math.random()*types.length)]; const el=document.createElement('div'); el.className='spawn-item '+t; el.textContent = t==='syringe'? 'üíâ Jeringa' : (t==='clock'?'‚è±Ô∏è Tiempo':'ü´ß Pista'); const x = Math.random()*(stageCanvas.clientWidth-140); const y = 60 + Math.random()*(stageCanvas.clientHeight-160); el.style.left = x+'px'; el.style.top = y+'px'; stageCanvas.appendChild(el);
        let vy=(Math.random()*0.6+0.2)*(Math.random()>0.5?1:-1); const floatInt=setInterval(()=>{ if(!el.parentElement){ clearInterval(floatInt); return; } const curY=parseFloat(el.style.top); el.style.top=(curY+vy)+'px'; if(curY<20||curY>stageCanvas.clientHeight-60) vy*=-1; },180);
        const life=7000+Math.random()*8000; const timeout=setTimeout(()=>{ if(el.parentElement) el.remove(); clearInterval(floatInt); }, life);
        el.addEventListener('click', ()=>{ if(!playing) return; clearTimeout(timeout); clearInterval(floatInt); collectItem(t); el.remove(); }); }

      function collectItem(type){ if(type==='syringe'){ patientHP = Math.min(maxHP, patientHP+25); score += 8; addStat('used_syringes',1); beep(880,0.08); checkAchievements('jeringa_master'); } else if(type==='clock'){ score += 6; beep(720,0.08); if(qTimer){ clearInterval(qTimer); startQuestionTimer((Number(document.getElementById('timePerQ').value) || 18) + 6); } } else if(type==='hint'){ hintsAvailable +=1; score +=4; beep(960,0.08); } uiUpdate(); }

      function clearStageItems(){ stageCanvas.querySelectorAll('.spawn-item').forEach(n=>n.remove()); }

      // ---------- patient drain & level speed ----------
      function levelSpeed(lv){ switch(lv){ case 'Anatom√≠a': return 0.6; case 'Cardiolog√≠a': return 0.9; case 'Neurolog√≠a': return 1.4; case 'Urgencias': return 2.2; default:return 1; } }
      function startPatientDrain(){ if(patientDrainInterval) clearInterval(patientDrainInterval); const speed = levelSpeed(currentLevel); patientDrainInterval = setInterval(()=>{ if(!playing) return; patientHP = Math.max(0, patientHP - speed); // visual effect
          avatarImg.style.filter = `grayscale(${Math.max(0, 1 - patientHP/120)}) contrast(${1 - (100-patientHP)/600})`;
          avatarImg.style.transform = `scale(${1 + (100-patientHP)/2000})`;
          uiUpdate(); if(patientHP <= 0){ endRound(false); } }, 1200); }

      // ---------- questions ----------
      function nextQuestion(){ if(!playing) return; if(activeQuestion) return; const pool = LEVELS[currentLevel]; const q = pool[Math.floor(Math.random()*pool.length)]; activeQuestion = JSON.parse(JSON.stringify(q)); showQuestion(activeQuestion); }

      function showQuestion(q){ qmodal.style.display='block'; qtext.textContent = q.q; qhint.textContent = '---'; opts.innerHTML=''; const letters=['A','B','C','D']; const arr = q.a.map((t,i)=>({t,i})); shuffle(arr); arr.forEach((o,idx)=>{ const b=document.createElement('div'); b.className='optbtn'; b.dataset.index = o.i; b.innerHTML = `<strong>${letters[idx]})</strong> ${o.t}`; b.addEventListener('click', ()=> chooseAnswer(b)); opts.appendChild(b); }); startQuestionTimer(Number(document.getElementById('timePerQ').value) || 18); }

      function startQuestionTimer(seconds){ if(qTimer) clearInterval(qTimer); let t=seconds; roundTimerEl.textContent = t+'s'; qTimer = setInterval(()=>{ t--; roundTimerEl.textContent = t+'s'; if(t<=4) roundTimerEl.style.color='orange'; if(t<=2) roundTimerEl.style.color='red'; if(t<=0){ clearInterval(qTimer); qTimer=null; errors +=1; patientHP = Math.max(0, patientHP - 14); score = Math.max(0, score - 5); combo = 0; beep(220,0.12); uiUpdate(); closeQuestion(); if(patientHP<=0) endRound(false); else setTimeout(()=> nextQuestion(),800); } },1000); }

      function stopQuestionTimer(){ if(qTimer) clearInterval(qTimer); qTimer=null; roundTimerEl.textContent='--'; roundTimerEl.style.color='inherit'; }

      function chooseAnswer(btn){ if(!activeQuestion) return; stopQuestionTimer(); const chosen = Number(btn.dataset.index); const correct = chosen === activeQuestion.r; Array.from(opts.children).forEach(o=>o.classList.add('disabled'));
        if(correct){ btn.style.outline='4px solid rgba(16,185,129,0.12)'; combo++; score += 15 * Math.max(1, Math.min(3, combo)); patientHP = Math.min(maxHP, patientHP+18); beep(880,0.08); avatarImg.src = AVATARS.happy; addStat('correct_answers',1); if(combo>=5) checkAchievements('combo_5'); } else { btn.style.outline='4px solid rgba(239,68,68,0.12)'; errors +=1; patientHP = Math.max(0, patientHP - 14); score = Math.max(0, score - 6); combo = 0; beep(200,0.12); avatarImg.src = AVATARS.critical; }
        uiUpdate(); setTimeout(()=>{ avatarImg.src = AVATARS.neutral; closeQuestion(); if(patientHP<=0) endRound(false); else nextQuestion(); },900);
      }

      function closeQuestion(){ qmodal.style.display='none'; activeQuestion=null; stopQuestionTimer(); }

      // use hint
      document.getElementById('useHint').addEventListener('click', ()=>{ if(!activeQuestion) return; if(hintsAvailable<=0){ alert('No tienes burbujas de pista. Recoge burbujas rosas en la sala.'); return; } const optElems = Array.from(opts.children).filter(o=>!o.classList.contains('disabled')); const wrongs = optElems.filter(o=>Number(o.dataset.index)!==activeQuestion.r); if(wrongs.length){ const rEl = wrongs[Math.floor(Math.random()*wrongs.length)]; rEl.classList.add('disabled'); hintsAvailable -=1; score = Math.max(0, score-2); uiUpdate(); qhint.textContent = activeQuestion.hint || '...'; } });

      // ---------- achievements ----------
      function loadAchievements(){ const raw = localStorage.getItem('me_achs'); if(raw){ const saved = JSON.parse(raw); ACHS.forEach(a=>{ a.unlocked = !!saved[a.id]; }); } renderMedals(); }
      function saveAchievements(){ const obj = {}; ACHS.forEach(a=>{ if(a.unlocked) obj[a.id] = true; }); localStorage.setItem('me_achs', JSON.stringify(obj)); }
      function renderMedals(){ const el = document.getElementById('medalList'); el.innerHTML=''; ACHS.forEach(a=>{ const d = document.createElement('div'); d.className = 'medal' + (a.unlocked ? '' : ' locked'); d.innerHTML = `<div style="font-size:20px">${a.icon}</div><div><strong>${a.name}</strong><div style="font-size:12px;color:var(--muted)">${a.desc}</div></div>`; el.appendChild(d); }); }
      function checkAchievements(id){ // some simple checks
        if(id==='jeringa_master'){ const used = Number((savedStats['used_syringes']||0)); if(used>=10) unlock('jeringa_master'); }
        if(id==='combo_5'){ if(combo>=5) unlock('combo_5'); }
      }
      function unlock(id){ const a = ACHS.find(x=>x.id===id); if(!a || a.unlocked) return; a.unlocked = true; saveAchievements(); renderMedals(); showToast(`üèÖ Nuevo logro: ${a.name}`); }

      // check per-game achievements
      function onEndGame(win){ if(win){ addStat('total_saves',1); const saves = Number(savedStats['total_saves']||0); if(saves>=1) unlock('first_save'); if(saves>=3) unlock('three_saves'); if(score>=50) unlock('score_50'); } }

      // ---------- end round ----------
      function endRound(win){ stopAll(); clearStageItems(); playing=false; stopQuestionTimer(); activeQuestion=null; if(win){ score += 40; beep(1200,0.12); setTimeout(()=>{ alert('‚úÖ Paciente salvado! Nivel: '+currentLevel+' ‚Äî Puntaje: '+score); }, 200); } else { beep(160,0.18); setTimeout(()=>{ alert('‚ùå El paciente no sobrevivi√≥. Puntaje: '+score); }, 200); }
        onEndGame(win);
        saveBest(); uiUpdate(); }

      // ---------- game control ----------
      function resetGame(){ stopAll(); score=0; patientHP=maxHP; hintsAvailable=0; errors=0; activeQuestion=null; playing=false; combo=0; uiUpdate(); }
      function startGame(){ if(playing) return; playEntranceAnimation(()=>{ playing=true; score=0; patientHP=maxHP; hintsAvailable=0; errors=0; combo=0; uiUpdate(); startSpawn(); startPatientDrain(); nextQuestion(); saveBest(); }); }
      function stopAll(){ if(spawnInterval) clearInterval(spawnInterval); if(qTimer) clearInterval(qTimer); if(patientDrainInterval) clearInterval(patientDrainInterval); spawnInterval=null; qTimer=null; patientDrainInterval=null; }

      function startSpawn(){ if(spawnInterval) clearInterval(spawnInterval); spawnInterval = setInterval(()=>{ spawnRandomItem(); }, 2200); }

      // ---------- helpers ----------
      function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } }

      // ---------- save/load ----------
      document.getElementById('saveBtn').addEventListener('click', ()=>{ const data={level:currentLevel,score,patientHP,errors,hintsAvailable,shift}; localStorage.setItem('me_save', JSON.stringify(data)); alert('Progreso guardado.'); });
      document.getElementById('loadBtn').addEventListener('click', ()=>{ const raw=localStorage.getItem('me_save'); if(!raw){ alert('No hay progreso guardado.'); return; } const d=JSON.parse(raw); currentLevel=d.level||currentLevel; score=d.score||0; patientHP=d.patientHP||100; errors=d.errors||0; hintsAvailable=d.hintsAvailable||0; levelName.textContent=currentLevel; if(d.shift) applyShift(d.shift); uiUpdate(); alert('Progreso cargado.'); });

      // UI bindings
      document.getElementById('startBtn').addEventListener('click', ()=>{ startGame(); });
      document.getElementById('pauseBtn').addEventListener('click', ()=>{ if(!playing) return; playing=false; stopAll(); stopQuestionTimer(); alert('Juego pausado. Pulsa Iniciar para continuar.'); });
      document.getElementById('submitClose').addEventListener('click', ()=>{ closeQuestion(); });
      document.getElementById('timePerQ').addEventListener('input', (e)=>{ document.getElementById('timeLabel').textContent = e.target.value+'s'; });

      document.querySelectorAll('.levelBtn').forEach(b=>{ b.addEventListener('click', ()=>{ currentLevel=b.dataset.level; levelName.textContent=currentLevel; resetGame(); uiUpdate(); }); });

      document.getElementById('shiftBtn').addEventListener('click', ()=>{ shiftModal.style.display='block'; });
      shiftDay.addEventListener('click', ()=>{ shiftDay.classList.add('selected'); shiftNight.classList.remove('selected'); });
      shiftNight.addEventListener('click', ()=>{ shiftNight.classList.add('selected'); shiftDay.classList.remove('selected'); });
      document.getElementById('shiftClose').addEventListener('click', ()=>{ shiftModal.style.display='none'; });
      document.getElementById('shiftApply').addEventListener('click', ()=>{ const s = shiftDay.classList.contains('selected') ? 'day' : (shiftNight.classList.contains('selected') ? 'night' : null); if(s){ applyShift(s); shiftModal.style.display='none'; } else { alert('Selecciona un turno.'); } });

      document.getElementById('saveBtn').addEventListener('click', ()=>{});

      document.getElementById('showStats').addEventListener('click', ()=>{ const stats = JSON.parse(localStorage.getItem('me_stats')||'{}'); alert('Estad√≠sticas:\n' + Object.entries(stats).map(([k,v])=>`${k}: ${v}`).join('\n')); });

      // ---------- toast notifications ----------
      function showToast(text, ms=3200){ const t=document.createElement('div'); t.className='toast'; t.textContent = text; document.body.appendChild(t); setTimeout(()=>{ t.style.opacity=1; },20); setTimeout(()=>{ t.style.opacity=0; setTimeout(()=>t.remove(),400); }, ms); }

      // ---------- achievements persistence & load ----------
      loadAchievements();

      // ---------- load shift & ensure ----------
      ensureShift();

      // ---------- load avatar neutral ----------
      avatarImg.src = AVATARS.neutral;

      // expose for debugging
      window._medico = { startGame, resetGame, nextQuestion };

    });
  </script>
</body>
</html>
